<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Sena - Simulador Canhoto</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --primary-color: #209869;
            --primary-color-dark: #145f42;
            --box-bg: #fffae6;
        }

        body.theme-quina {
            --primary-color: #260085;
            --primary-color-dark: #1a005c;
            --box-bg: #e6e6fa;
        }

        /* LOTTERY SELECTOR */
        .lottery-selector {
            display: flex;
            gap: 10px;
        }

        .btn-lottery {
            padding: 8px 16px;
            border: 2px solid transparent;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            background: #f0f0f0;
            color: #555;
        }

        body.theme-megasena .btn-lottery[data-game="megasena"],
        body.theme-quina .btn-lottery[data-game="quina"] {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* PAGE LAYOUT & RESET */
        body {
            background-color: #f0f2f5;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            justify-content: center;
            padding-bottom: 140px;
            /* Space for sticky footer */
        }

        .main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px; /* Increased to allow wider sidebar */
            gap: 20px;
        }

        @media(min-width: 900px) {
            .content-wrapper {
                display: flex;
                align-items: flex-start;
                gap: 20px;
            }

            .game-section {
                flex: 1;
                display: flex;
                justify-content: center; /* Center the slip in its space */
            }

            .sidebar-section {
                width: 550px; /* Much wider to fill the gap to the left */
                flex-shrink: 0;
            }
        }

        /* HEADER DO SITE */
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title h1 {
            color: var(--primary-color);
            font-size: 1.8em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-nav a {
            text-decoration: none;
            color: #555;
            font-weight: 600;
            padding: 8px 16px;
            background: #f0f0f0;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .header-nav a:hover {
            background: #e0e0e0;
        }

        /* =========================================
           DIGITAL SLIP (THE GAME)
           ========================================= */
        .betting-slip {
            background: #fff;
            width: 100%;
            max-width: 420px;
            /* Wider for better margins */
            border-radius: 2px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            border-bottom: 4px solid #ddd;
        }

        .slip-header {
            background: var(--primary-color);
            padding: 20px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            overflow: hidden;
            border-bottom: 4px solid var(--primary-color-dark);
            /* Added margins to create white space around banner */
            margin: 20px 20px 0 20px;
            border-radius: 2px;
            /* Slight rounding for printed look */
        }

        .slip-header::after {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 140px;
            height: 140px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
        }

        .slip-header::before {
            content: '';
            position: absolute;
            bottom: -20px;
            left: -20px;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2;
        }

        .clover-icon {
            font-size: 3.5em;
            line-height: 1;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .brand-subtitle {
            display: block;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            letter-spacing: 1px;
            font-weight: 300;
            font-style: italic;
            /* Delicate Italic */
            color: #e0f2f1;
            text-transform: capitalize;
            margin-bottom: -2px;
            margin-left: 2px;
        }

        .brand-text h2 {
            font-size: 2.8em;
            font-weight: 900;
            margin: 0;
            letter-spacing: -1px;
            text-transform: uppercase;
            /* MEGA-SENA */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            color: #ffffff;
            line-height: 1;
        }

        /* SLIP BODY (Container for games) */
        .slip-body {
            padding: 10px 0 0 0;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 0;
            /* Remove gap completely for tighter look */
        }

        /* INDIVIDUAL GAME BLOCK */
        .game-block {
            padding: 0 20px 10px 20px;
            /* Reduced bottom padding */
            background: #ffffff;
            transition: all 0.3s;
        }

        /* Annulled state (User cancelled or not selected) */
        .game-block.annulled {
            opacity: 0.5;
            /* Slight opacity as requested */
        }

        .game-block.annulled .numbers-grid {
            pointer-events: none;
        }

        .game-yellow-wrapper {
            background-color: var(--box-bg);
            /* Yellow background for numbers only */
            padding: 10px 5px;
            border-radius: 4px;
        }

        .game-header {
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            color: #209869;
            margin-bottom: 5px;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            padding-left: 5px;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            justify-items: center;
        }

        .number-box {
            width: 100%;
            /* Fluid width */
            aspect-ratio: 1.4;
            /* Maintain shape */
            border: none;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            position: relative;
            font-size: 0.85em;
            color: #d63031;
            font-weight: 700;
            font-family: 'Roboto Mono', monospace;
            transition: all 0.1s;
            cursor: pointer;
        }

        /* ... existing styles ... */

        /* RESPONSIVE ADJUSTMENTS */
        @media (max-width: 480px) {
            .betting-slip {
                max-width: 100%;
                border-radius: 0;
            }

            .slip-header {
                padding: 20px 15px;
                margin: 10px 10px 0 10px;
                /* Smaller margins */
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .brand-logo {
                flex-flow: row nowrap !important;
                /* Force single line */
                align-items: center;
                justify-content: center;
                gap: 8px;
                width: 100%;
            }

            .clover-icon {
                font-size: 8vw !important;
                flex-shrink: 0;
                /* Prevent icon squishing */
            }

            .brand-text {
                min-width: 0;
                /* Allow flex shrinking */
            }

            .brand-text h2 {
                white-space: nowrap !important;
                font-size: 8vw !important;
                line-height: 1;
                display: block;
            }

            .brand-subtitle {
                font-size: 3vw;
                letter-spacing: 0.5px;
            }

            .game-block {
                padding: 0 10px 10px 10px;
                /* Tighter padding */
            }

            .game-yellow-wrapper {
                padding: 5px 2px;
            }

            .number-box {
                font-size: 0.7em;
                /* Smaller numbers */
            }

            .annul-row {
                font-size: 0.9em;
                /* Scale down annul text */
                padding: 0 5px;
            }

            .native-control-row {
                padding: 10px 15px;
            }

            .native-label {
                font-size: 0.65em;
            }

            .btn-num-select {
                padding: 4px 0;
                font-size: 0.75em;
            }
        }

        /* SEARCHING EFFECT REMOVED */

        /* Shared Scribble Effect */
        .number-box.marked,
        .number-box.selected,
        .btn-num-select.active {
            background-color: transparent !important;
            color: #fff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            box-shadow: none;
            position: relative;
            z-index: 1;
            transition: color 0.1s ease-in 0.6s;
            /* Wait for scribble (0.6s) to finish */
        }

        .number-box.marked::after,
        .number-box.selected::after,
        .btn-num-select.active::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;

            /* 5-Frame Sprite SVG - Green Pen */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 60' preserveAspectRatio='none'%3E%3Cdefs%3E%3Cstyle%3E.s%7Bfill:none;stroke:%23209869;stroke-width:14;stroke-linecap:round;stroke-linejoin:round;opacity:0.9;%7D%3C/style%3E%3C/defs%3E%3C!-- F1 --%3E%3Cpolyline points='5,15 95,15' class='s'/%3E%3C!-- F2 --%3E%3Cg transform='translate(100,0)'%3E%3Cpolyline points='5,15 95,15 10,25' class='s'/%3E%3C/g%3E%3C!-- F3 --%3E%3Cg transform='translate(200,0)'%3E%3Cpolyline points='5,15 95,15 10,25 90,35' class='s'/%3E%3C/g%3E%3C!-- F4 --%3E%3Cg transform='translate(300,0)'%3E%3Cpolyline points='5,15 95,15 10,25 90,35 5,45' class='s'/%3E%3C/g%3E%3C!-- F5 --%3E%3Cg transform='translate(400,0)'%3E%3Cpolyline points='5,15 95,15 10,25 90,35 5,45 95,55' class='s'/%3E%3C/g%3E%3C/svg%3E");

            background-size: 500% 100%;
            /* 5 frames horizontal */
            background-position: 0 0;
            pointer-events: none;
            mix-blend-mode: multiply;

            animation: scribble-sprite 0.6s steps(4) forwards;
        }

        body.theme-quina .number-box.marked::after,
        body.theme-quina .number-box.selected::after,
        body.theme-quina .btn-num-select.active::after {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 500 60' preserveAspectRatio='none'%3E%3Cdefs%3E%3Cstyle%3E.s%7Bfill:none;stroke:%23260085;stroke-width:14;stroke-linecap:round;stroke-linejoin:round;opacity:0.9;%7D%3C/style%3E%3C/defs%3E%3C!-- F1 --%3E%3Cpolyline points='5,15 95,15' class='s'/%3E%3C!-- F2 --%3E%3Cg transform='translate(100,0)'%3E%3Cpolyline points='5,15 95,15 10,25' class='s'/%3E%3C/g%3E%3C!-- F3 --%3E%3Cg transform='translate(200,0)'%3E%3Cpolyline points='5,15 95,15 10,25 90,35' class='s'/%3E%3C/g%3E%3C!-- F4 --%3E%3Cg transform='translate(300,0)'%3E%3Cpolyline points='5,15 95,15 10,25 90,35 5,45' class='s'/%3E%3C/g%3E%3C!-- F5 --%3E%3Cg transform='translate(400,0)'%3E%3Cpolyline points='5,15 95,15 10,25 90,35 5,45 95,55' class='s'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* Adjust button specific spacing if needed */
        .btn-num-select.active {
            transform: scale(1.1);
        }

        @keyframes scribble-sprite {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 100% 0;
            }
        }

        /* ANNULMENT ROW */
        .annul-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Text Left, Box Right */
            gap: 8px;
            margin-top: 5px;
            padding: 0 10px;
            /* Balanced padding */
            white-space: nowrap;
        }

        .annul-phrase {
            font-size: 0.65em;
            color: #d63031;
            font-weight: 700;
            text-transform: uppercase;
        }

        .annul-checkbox {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            color: #d63031;
            font-size: 1em;
            /* Larger bracket */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            line-height: 1;
        }

        .annul-checkbox.checked {
            background: #d63031;
            color: white;
            border-radius: 2px;
        }

        /* NUMBER QUANTITY BUTTONS (Native Look) */
        .native-control-row {
            display: flex;
            flex-direction: column;
            /* Stack vertically */
            align-items: flex-start;
            gap: 8px;
            padding: 15px 20px;
            /* Padding for the white box */
            background: #ffffff;
            /* White background */
            /* Border removed */
        }

        /* New variant for horizontal layout */
        .native-control-row.row-horizontal {
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
        }

        .native-label {
            font-size: 0.7em;
            /* Similar to 'Para anular...' */
            font-weight: 700;
            color: #d63031;
            text-transform: uppercase;
            width: 100%;
            line-height: 1.2;
        }

        .native-control-row.row-horizontal .native-label {
            width: auto;
            /* Allow auto width for horizontal row */
        }

        .num-selector-row {
            display: flex;
            flex-wrap: nowrap;
            /* Force single line */
            justify-content: space-between;
            /* Spread evenly */
            align-items: center;
            width: 100%;
        }

        .btn-num-select {
            border: none;
            background: transparent;
            color: #d63031;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.1s;
            font-size: 0.85em;
            padding: 4px 0;
            /* Minimal padding */
            border-radius: 2px;
            white-space: nowrap;
        }

        .btn-num-select:hover {
            background: rgba(214, 48, 49, 0.1);
        }

        /* Removed redundant active style */

        /* Updated Footer styles */
        .slip-footer {
            padding: 0;
            /* Remove padding to merge with body flow */
            background: #ffffff;
            /* White like the rest of the slip */
            display: flex;
            flex-direction: column;
            /* gap: 15px; - handled by children padding */
        }

        .control-section-title {
            font-size: 0.8em;
            font-weight: 700;
            color: #555;
            margin-bottom: 8px;
            text-transform: uppercase;
            text-align: center;
        }

        /* SLIP FOOTER (Controls area now here) */
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-label {
            font-size: 0.75em;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
        }

        .qty-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-qty {
            width: 28px;
            height: 28px;
            border: none;
            background: #eee;
            color: #444;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .btn-qty:hover {
            background: #ddd;
        }

        .qty-display {
            font-weight: bold;
            font-size: 1.1em;
            color: #209869;
            width: 30px;
            text-align: center;
        }

        .btn-action {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--primary-color-dark);
            transition: all 0.1s;
        }

        .btn-action:hover {
            background: var(--primary-color-dark);
        }

        .btn-action:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--primary-color-dark);
        }

        .btn-action:disabled {
            background: #ccc;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }

        .status-msg {
            text-align: center;
            font-size: 0.9em;
            font-weight: 600;
            color: #555;
        }


        /* SIDEBAR (HISTORY) */
        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Default gap */
        }

        .history-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            max-height: 75vh; /* Taller on mobile */
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* DESKTOP SPECIFIC OVERRIDES */
        @media(min-width: 900px) {
            .content-wrapper {
                display: flex;
                align-items: stretch; /* Make sidebar same height as slip */
                gap: 20px;
            }

            .game-section {
                flex: 1;
                display: flex;
                justify-content: center;
            }

            .sidebar-section {
                width: 550px;
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                gap: 10px; /* Closer gap between Result and History */
            }
            
            .history-card {
                max-height: none; /* Remove limit to align with slip bottom */
            }

            /* Results card should be compact */
            .results-card {
                flex: 0 0 auto;
            }

            /* History list should fill the rest */
            .history-list-card {
                flex: 1;
                min-height: 200px;
                max-height: 500px;
                overflow-y: auto;
            }
        }

        .history-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            background: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
        }

        .h-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #888;
            margin-bottom: 8px;
        }

        .h-id {
            font-weight: bold;
            color: var(--primary-color);
        }

        .h-games-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .h-game-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .h-game-label {
            font-size: 0.7em;
            font-weight: bold;
            color: #aaa;
            width: 40px;
        }

        .mini-ball {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-copy-history {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            padding: 2px 6px;
            margin-left: 10px;
            transition: all 0.2s;
            color: #555;
        }

        .btn-copy-history:hover {
            background: #e0f2f1;
            color: var(--primary-color);
            border-color: var(--primary-color);
        }



        /* STICKY FOOTER CONTROLS */
        /* STICKY FOOTER CONTROLS - Full Width App Style */
        .sticky-controls-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            animation: slideUp 0.3s ease-out;
        }

        /* Container to keep content centered and distinct on wide screens */
        .sticky-inner {
            width: 100%;
            max-width: 600px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .sticky-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .sticky-status {
            font-size: 0.8em;
            text-align: center;
            color: #666;
            margin-bottom: -5px;
        }
    </style>
    <style>
        /* RESULT CHECKER STYLES */
        .contest-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            background: #fff;
            border: 1px solid #ddd;
            width: 32px; /* Slightly larger for better tap area */
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            color: #555;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0; /* Clear padding */
            line-height: normal; /* Reset line-height */
            font-size: 1.2em; /* Increase arrow size slightly */
        }
        .nav-btn:hover { background: #eee; color: #209869; border-color: #209869; }
        
        .contest-label {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.9em;
        }
        
        .contest-date {
            font-size: 0.75em;
            text-align: center;
            color: #888;
            margin-bottom: 15px;
        }
        
        .contest-numbers {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .result-ball {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* MATCH HIGHLIGHT IN HISTORY */
        .mini-ball.match {
            background: #f1c40f !important; /* Gold for win */
            color: #fff !important;
            box-shadow: 0 0 5px #f1c40f;
            transform: scale(1.1);
            z-index: 2;
        }
        
        .match-count {
            font-size: 0.7em; 
            font-weight: bold; 
            color: #f1c40f; 
            margin-left: 5px;
            text-transform: uppercase;
        }

        /* NEW RESULT DETAILS */
        .result-details {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 0.85em;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        .status-accumulated { background-color: #0984e3; } /* Blue for Accumulate */
        .status-won { background-color: var(--primary-color); } /* Green for Win */
        
        .prize-value {
            font-size: 1.2em;
            font-weight: 900;
            color: #333;
            margin-bottom: 5px;
        }
        .winner-location {
            color: #666;
            font-style: italic;
            font-size: 0.9em;
        }

        /* WIN PILLS (Badges) */
        .win-badge {
            display: inline-block;
            font-size: 0.65em;
            font-weight: 800;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            vertical-align: middle;
        }
        .badge-quadra { background: #3498db; } /* Blue */
        .badge-quina { background: #9b59b6; } /* Purple */
        .badge-sena { 
            background: linear-gradient(45deg, #f1c40f, #e67e22);
            color: #fff;
            border: 1px solid #fff;
            animation: pulse-gold 2s infinite; 
        }
        
        @keyframes pulse-gold {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 5px rgba(241, 196, 15, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
        }

        /* RESPONSIVE FIXES */
        /* Only apply full width on small screens via Media Query if needed, 
           otherwise let the main media query handle widths */
        @media (max-width: 899px) {
            .sidebar-section {
                width: 100%;
                max-width: 100%;
            }
        }
        
        .history-card {
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden; /* Prevent horizontal overflow only */
            overflow-y: auto;   /* Restore vertical scroll */
        }

        .h-game-row {
            flex-wrap: wrap; /* Allow wrapping on very small screens */
            gap: 5px;
        }
    </style>
</head>

<body>

    <div class="main-container">

        <header class="page-header">
            <div class="header-title">
                <h1><span id="headerCloverIcon">üçÄ</span> <span id="headerTitleText">Mega Sena</span> <small style="font-size:0.5em;color:#999; margin-left:10px;">Simulador</small></h1>
            </div>
            <div class="lottery-selector">
                <button class="btn-lottery" data-game="megasena" onclick="switchLottery('megasena')">Mega-Sena</button>
                <button class="btn-lottery" data-game="quina" onclick="switchLottery('quina')">Quina</button>
            </div>
        </header>

        <div class="content-wrapper">

            <div class="game-section">
                <div class="betting-slip">

                    <div class="slip-header">
                        <div class="brand-logo">
                            <div class="clover-icon" id="slipCloverIcon">üçÄ</div>
                            <div class="brand-text">
                                <span class="brand-subtitle">Sorteador</span>
                                <h2 id="slipTitleText">mega&#8209;sena</h2>
                            </div>
                        </div>
                    </div>

                    <!-- Games Container -->
                    <div class="slip-body" id="slipBody">
                        <!-- JS creates Game 1, 2, 3 here -->
                    </div>

                    <!-- Footer Controls -->
                    <div class="slip-footer">

                        <!-- QUANTITY OF NUMBERS -->
                        <div class="native-control-row">
                            <div class="native-label">Assinale quantos n√∫meros voc√™ quer jogar:</div>
                            <div class="num-selector-row" id="numSelectorParams">
                                <!-- JS Injects [06] [07] ... -->
                            </div>
                        </div>

                    </div>
                    <!-- Moved other controls to sticky footer -->
                </div>

            </div>
            <!-- Sidebar was misplaced -->
            <div class="sidebar-section">
                <!-- RESULT CHECKER CARD -->
                <div class="history-card results-card">
                    <div class="history-title">
                        <span>üèÜ Resultados</span>
                    </div>
                    <div class="contest-nav">
                        <button class="nav-btn" id="btnPrevContest">&lt;</button>
                        <span class="contest-label" id="contestLabel">Carregando...</span>
                        <button class="nav-btn" id="btnNextContest">&gt;</button>
                    </div>
                    <div class="contest-date" id="contestDate">DATA: --/--/----</div>
                    <div class="contest-numbers" id="contestResults">
                        <!-- Balls go here -->
                        <span style="font-size:0.8em; color:#999;">Aguardando...</span>
                    </div>
                    
                    <!-- NEW DETAILS SECTION -->
                    <div class="result-details" id="resultDetails">
                        <div id="resStatusBadge" class="status-badge" style="display:none;"></div>
                        <div id="resPrize" class="prize-value"></div>
                        <div id="resLocation" class="winner-location"></div>
                    </div>
                </div>

                <!-- HISTORY CARD -->
                <div class="history-card history-list-card">
                    <div class="history-title">
                        <span>üìú Hist√≥rico</span>
                        <button onclick="clearHistory()"
                            style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:0.8em;">Limpar</button>
                    </div>
                    <ul class="history-list" id="historyList"></ul>
                </div>
                
                <!-- NEW PRIZE INFO CARD -->
                <div class="history-card prize-info-card" style="margin-top: 15px;">
                    <div class="history-title">
                        <span>‚ÑπÔ∏è Premia√ß√µes do Jogo</span>
                    </div>
                    <div id="prizeInfoText" style="font-size: 0.85em; color: #555; line-height: 1.5; padding: 10px 0;">
                        <strong>Mega-Sena:</strong><br>
                        ‚Ä¢ <strong>Sena (6 acertos):</strong> Pr√™mio m√°ximo.<br>
                        ‚Ä¢ <strong>Quina (5 acertos):</strong> Pr√™mio intermedi√°rio.<br>
                        ‚Ä¢ <strong>Quadra (4 acertos):</strong> Pr√™mio menor.
                    </div>
                </div>
            </div>

        </div> <!-- End content-wrapper -->
    </div> <!-- End main-container -->

    <div class="sticky-controls-bar">
        <div class="sticky-inner">
            <!-- Status Message First -->
            <div class="sticky-status" id="statusMsg">Configure sua aposta</div>

            <div class="sticky-row">
                <!-- Game Quantity Controls -->
                <div class="native-control-row row-horizontal" style="padding:0; background:transparent; gap:10px;">
                    <div class="native-label">JOGOS:</div>
                    <div class="qty-selector">
                        <button class="btn-qty" id="btnGameMinus">-</button>
                        <div class="qty-display" id="gameQtyDisplay">3</div>
                        <button class="btn-qty" id="btnGamePlus">+</button>
                    </div>
                </div>

                <!-- Action Button -->
                <button class="btn-action" id="btnSimulate"
                    style="width: auto; padding: 8px 25px; min-width: 150px;">SORTEAR üé≤</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initMegaPage();
        });

        function initMegaPage() {
            // State
            window.config = {
                gameQty: 3, // 1 to 3
                numQty: 6,   // 6 to 15
                maxNum: 60,
                minBet: 6,
                maxBet: 15,
                gameType: 'megasena'
            };
            let manualSelections = { 1: new Set(), 2: new Set(), 3: new Set() };
            let manualAnnulments = new Set();
            let isAnimating = false;
            // Global state for contest results
            window.currentContestData = null;

            // DOM
            const slipBody = document.getElementById('slipBody');

            const btnGameMinus = document.getElementById('btnGameMinus');
            const btnGamePlus = document.getElementById('btnGamePlus');
            const gameQtyDisplay = document.getElementById('gameQtyDisplay');

            const numSelectorContainer = document.getElementById('numSelectorParams');

            const btnSimulate = document.getElementById('btnSimulate');
            const statusMsg = document.getElementById('statusMsg');

            const btnPrevContest = document.getElementById('btnPrevContest');
            const btnNextContest = document.getElementById('btnNextContest');

            // --- Global Methods ---
            window.switchLottery = function(gameType) {
                if (isAnimating) return;
                
                window.config.gameType = gameType;
                document.body.className = `theme-${gameType}`;
                
                document.querySelectorAll('.btn-lottery').forEach(btn => {
                    if (btn.dataset.game === gameType) btn.classList.add('active');
                    else btn.classList.remove('active');
                });

                if (gameType === 'megasena') {
                    window.config.maxNum = 60;
                    window.config.minBet = 6;
                    if (window.config.numQty < 6) window.config.numQty = 6;
                    document.getElementById('headerCloverIcon').textContent = 'üçÄ';
                    document.getElementById('headerTitleText').textContent = 'Mega Sena';
                    document.getElementById('slipCloverIcon').textContent = 'üçÄ';
                    document.getElementById('slipTitleText').innerHTML = 'mega&#8209;sena';
                    
                    document.getElementById('prizeInfoText').innerHTML = `
                        <strong>Mega-Sena:</strong><br>
                        ‚Ä¢ <strong>Sena (6 acertos):</strong> Pr√™mio m√°ximo.<br>
                        ‚Ä¢ <strong>Quina (5 acertos):</strong> Pr√™mio intermedi√°rio.<br>
                        ‚Ä¢ <strong>Quadra (4 acertos):</strong> Pr√™mio menor.
                    `;
                } else {
                    window.config.maxNum = 80;
                    window.config.minBet = 5;
                    if (window.config.numQty > 15) window.config.numQty = 15;
                    if (window.config.numQty < 5) window.config.numQty = 5; 
                    document.getElementById('headerCloverIcon').textContent = 'üé±';
                    document.getElementById('headerTitleText').textContent = 'Quina';
                    document.getElementById('slipCloverIcon').textContent = 'üé±';
                    document.getElementById('slipTitleText').innerHTML = 'quina';
                    
                    document.getElementById('prizeInfoText').innerHTML = `
                        <strong>Quina:</strong><br>
                        ‚Ä¢ <strong>Quina (5 acertos):</strong> Pr√™mio principal.<br>
                        ‚Ä¢ <strong>Quadra (4 acertos):</strong> Pr√™mio grande.<br>
                        ‚Ä¢ <strong>Terno (3 acertos):</strong> Pr√™mio intermedi√°rio.<br>
                        ‚Ä¢ <strong>Duque (2 acertos):</strong> Pr√™mio menor.
                    `;
                }
                
                manualSelections = { 1: new Set(), 2: new Set(), 3: new Set() };
                manualAnnulments = new Set();
                
                initNumButtons();
                createGamesGrid();
                updateControlsUI();
                
                fetchContest('latest');
            };

            // --- Init ---
            document.body.className = 'theme-megasena';
            initNumButtons();
            createGamesGrid();
            updateControlsUI();
            updateHistoryUI();
            fetchContest('latest'); // Load latest result

            // --- Handlers ---
            btnGameMinus.onclick = () => { if (!isAnimating && window.config.gameQty > 1) { window.config.gameQty--; updateControlsUI(); } };
            
            btnPrevContest.onclick = () => {
                if(window.currentContestData && window.currentContestData.numero) {
                    fetchContest(window.currentContestData.numero - 1);
                }
            };
            btnNextContest.onclick = () => {
                 if(window.currentContestData && window.currentContestData.numero) {
                    fetchContest(window.currentContestData.numero + 1);
                }
            };
            btnGamePlus.onclick = () => { if (!isAnimating && window.config.gameQty < 3) { window.config.gameQty++; updateControlsUI(); } };

            btnSimulate.onclick = runSimulation;

            // --- Functions ---

            function initNumButtons() {
                numSelectorContainer.innerHTML = '';
                for (let i = window.config.minBet; i <= window.config.maxBet; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'btn-num-select';
                    // Format like the grid: [06]
                    btn.innerHTML = `[${String(i).padStart(2, '0')}]`;
                    btn.onclick = () => {
                        if (isAnimating) return;
                        window.config.numQty = i;
                        enforceManualSelectionLimit();
                        updateControlsUI();
                    };
                    numSelectorContainer.appendChild(btn);
                }
            }

            function createGamesGrid() {
                slipBody.innerHTML = '';
                for (let g = 1; g <= 3; g++) {
                    const gameDiv = document.createElement('div');
                    gameDiv.className = 'game-block';
                    gameDiv.id = `game-block-${g}`;

                    // Wrapper
                    const yellowWrapper = document.createElement('div');
                    yellowWrapper.className = 'game-yellow-wrapper';

                    const grid = document.createElement('div');
                    grid.className = 'numbers-grid';
                    grid.id = `grid-${g}`;

                    for (let i = 1; i <= window.config.maxNum; i++) {
                        const box = document.createElement('div');
                        box.className = 'number-box';
                        box.id = `g${g}-num-${i}`;
                        box.innerHTML = `<span>[${String(i).padStart(2, '0')}]</span>`;
                        box.onclick = () => toggleManualSelection(g, i);
                        grid.appendChild(box);
                    }
                    yellowWrapper.appendChild(grid);

                    // Annulment Row
                    const annulRow = document.createElement('div');
                    annulRow.className = 'annul-row';

                    const phrase = document.createElement('div');
                    phrase.className = 'annul-phrase';
                    // Added colon as requested common pattern
                    phrase.textContent = "Para anular este jogo, marque ao lado:";
                    annulRow.appendChild(phrase);

                    const checkbox = document.createElement('div');
                    checkbox.className = 'annul-checkbox';
                    checkbox.id = `annul-check-${g}`;
                    // Visually represent box
                    checkbox.innerHTML = `[ ]`;
                    checkbox.onclick = () => toggleAnnulment(g);
                    annulRow.appendChild(checkbox);

                    yellowWrapper.appendChild(annulRow);

                    gameDiv.appendChild(yellowWrapper);

                    slipBody.appendChild(gameDiv);
                }
            }

            function getActiveGameCount() {
                let count = 0;
                for (let i = 1; i <= window.config.gameQty; i++) {
                    if (!manualAnnulments.has(i)) count++;
                }
                return count;
            }

            function updateControlsUI() {
                const activeCount = getActiveGameCount();
                gameQtyDisplay.textContent = activeCount;

                // Update Num Buttons State
                const buttons = numSelectorContainer.children;
                for (let btn of buttons) {
                    const val = parseInt(btn.textContent.replace(/\D/g, ''));
                    if (val === window.config.numQty) btn.classList.add('active');
                    else btn.classList.remove('active');
                }

                // Toggle Games State (Active vs Annulled)
                for (let g = 1; g <= 3; g++) {
                    const block = document.getElementById(`game-block-${g}`);
                    const checkbox = document.getElementById(`annul-check-${g}`);

                    // A game is active if it's within the quantity range AND not manually annulled
                    const isActive = (g <= window.config.gameQty) && !manualAnnulments.has(g);

                    if (isActive) {
                        // Active Game
                        block.classList.remove('annulled');
                        if (checkbox) {
                            checkbox.classList.remove('checked');
                            checkbox.style.background = 'transparent';
                            checkbox.style.color = '#d63031';
                        }
                    } else {
                        // Inactive/Annulled Game
                        block.classList.add('annulled');
                        // Only clear grid marks if it's out of range, 
                        // if it's just manually annulled, maybe keep marks? 
                        // Let's clear searching marks but maybe keep selection? 
                        // For now, to be consistent with "disabled", let's leave marks but dimmed.
                        // But clearGrid removes 'searching' which is good.
                        clearGrid(g);

                        // Mark the annul checkbox
                        if (checkbox) {
                            checkbox.classList.add('checked');
                            checkbox.style.background = '#d63031';
                            checkbox.style.color = 'white';
                        }
                    }
                }

                statusMsg.textContent = `${activeCount} Jogo(s) com ${window.config.numQty} n√∫meros. Clique nos n√∫meros para marcar.`;
            }

            function toggleAnnulment(gameId) {
                if (isAnimating) return;
                // Only allow toggling if within active range (otherwise it's forced annulled)
                if (gameId > window.config.gameQty) return;

                if (manualAnnulments.has(gameId)) {
                    manualAnnulments.delete(gameId);
                } else {
                    manualAnnulments.add(gameId);
                }
                updateControlsUI();
            }

            function toggleManualSelection(gameId, num) {
                if (isAnimating) return;
                // If game is annuled (not in active range), ignore
                if (gameId > window.config.gameQty) return;

                const set = manualSelections[gameId];
                const box = document.getElementById(`g${gameId}-num-${num}`);

                if (set.has(num)) {
                    // Unselect
                    set.delete(num);
                    box.classList.remove('selected');
                } else {
                    // Select
                    if (set.size >= window.config.numQty) {
                        alert(`Voc√™ j√° selecionou ${window.config.numQty} n√∫meros para este jogo!`);
                        return;
                    }
                    set.add(num);
                    box.classList.add('selected');
                }
            }

            function clearGrid(gameId) {
                const grid = document.getElementById(`grid-${gameId}`);
                if (grid) {
                    // Remove 'marked' (auto-generated) and 'searching' classes
                    // Keep 'selected' (manual) class
                    grid.querySelectorAll('.number-box').forEach(el => el.classList.remove('marked', 'searching'));
                }
            }

            async function runSimulation() {
                if (isAnimating) return;
                isAnimating = true;
                btnSimulate.disabled = true;
                statusMsg.style.color = 'var(--primary-color)';

                // Scroll to top of slip to show drawing
                const slipHeader = document.querySelector('.slip-header');
                if (slipHeader) {
                    slipHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                // Clear active grids
                for (let g = 1; g <= window.config.gameQty; g++) clearGrid(g);

                const allResults = [];

                // Sequential animation for each game
                for (let g = 1; g <= window.config.gameQty; g++) {
                    // Skip if manually annulled
                    if (manualAnnulments.has(g)) continue;

                    statusMsg.textContent = `Sorteando JOGO ${g}...`;

                    // Generate numbers
                    const pool = Array.from({ length: window.config.maxNum }, (_, i) => i + 1);

                    // Start with manual selections
                    const currentSet = manualSelections[g];
                    const winners = Array.from(currentSet);

                    // Filter pool to exclude already selected
                    const availablePool = pool.filter(n => !currentSet.has(n));

                    // How many more do we need?
                    const needed = window.config.numQty - winners.length;

                    const newPicks = [];
                    for (let i = 0; i < needed; i++) {
                        const idx = Math.floor(Math.random() * availablePool.length);
                        const picked = availablePool.splice(idx, 1)[0];
                        newPicks.push(picked);
                        winners.push(picked);
                    }

                    // Animate only the new picks
                    for (let n of newPicks) {
                        await playRouletteEffect(g, n);
                        const el = document.getElementById(`g${g}-num-${n}`);
                        el.classList.add('marked');
                        // Wait for scribble animation to finish properly before next one
                        await new Promise(r => setTimeout(r, 700));
                    }

                    // If no new picks (fully manual), just wait a sec to show "processing"
                    if (needed === 0) {
                        await new Promise(r => setTimeout(r, 500));
                    }

                    allResults.push({ game: g, numbers: winners.sort((a, b) => a - b) });
                }

                isAnimating = false;
                btnSimulate.disabled = false;
                statusMsg.textContent = "Sorteio Finalizado!";
                statusMsg.style.color = '#555';

                addToHistory(allResults);
            }

            // Ensures that if user lowers the total numbers (e.g. 10 -> 6),
            // we remove any extra manual selections so the game remains valid.
            function enforceManualSelectionLimit() {
                for (let g = 1; g <= 3; g++) {
                    const set = manualSelections[g];
                    if (set.size > window.config.numQty) {
                        const arr = Array.from(set);
                        const toKeep = arr.slice(0, window.config.numQty);
                        const toRemove = arr.slice(window.config.numQty);

                        // Update Set
                        manualSelections[g] = new Set(toKeep);

                        // Update Visuals
                        toRemove.forEach(num => {
                            const el = document.getElementById(`g${g}-num-${num}`);
                            if (el) el.classList.remove('selected');
                        });
                    }
                }
            }

            async function playRouletteEffect(gameId, targetNum) {
                // Effect removed as requested.
                // Just a tiny pause to ensure sequential feeling if desired, or nothing.
                await new Promise(r => setTimeout(r, 10));
            }

            // History Logic (Same as before)
            function addToHistory(results) {
                const history = JSON.parse(localStorage.getItem('mega_history') || '[]');
                const newItem = {
                    id: history.length > 0 ? history[0].id + 1 : 1,
                    date: new Date().toISOString(),
                    games: results
                };
                history.unshift(newItem);
                if (history.length > 50) history.pop();
                localStorage.setItem('mega_history', JSON.stringify(history));
                
                // If we have a contest loaded, check this new item against it
                const matchNumbers = window.currentContestData ? window.currentContestData.listaDezenas.map(d => parseInt(d)) : null;
                updateHistoryUI(matchNumbers);
            }
        }

        window.copyHistoryItem = function (id, btn) {
            const history = JSON.parse(localStorage.getItem('mega_history') || '[]');
            const item = history.find(h => h.id === id);
            if (!item) return;

            let text = '';
            if (item.games) {
                item.games.forEach(g => {
                    text += g.numbers.map(n => String(n).padStart(2, '0')).join(' ') + '\n';
                });
            } else if (item.numbers) {
                text += item.numbers.map(n => String(n).padStart(2, '0')).join(' ') + '\n';
            }

            navigator.clipboard.writeText(text).then(() => {
                const original = btn.innerHTML;
                btn.innerHTML = 'Copiado!';
                btn.style.color = '#209869';
                btn.style.borderColor = '#209869';
                setTimeout(() => {
                    btn.innerHTML = original;
                    btn.style.color = '#555';
                    btn.style.borderColor = '#ddd';
                }, 1500);
            });
        };

        // Added optional parameter to highlight matches
        function updateHistoryUI(matchAgainst = null) {
            const list = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('mega_history') || '[]');

            if (!list) return;
            list.innerHTML = '';

            if (history.length === 0) {
                list.innerHTML = '<li style="padding:20px; text-align:center; color:#999;">Hist√≥rico Vazio</li>';
                return;
            }

            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';

                // Helper to check match
                const isMatch = (n) => matchAgainst ? matchAgainst.includes(n) : false;

                // If old format (flat numbers array), convert to new format structure for display
                let gamesContent = '';
                if (item.games) {
                    item.games.forEach(g => {
                        // Calculate matches for this game
                        let hits = 0;
                        const balls = g.numbers.map(n => {
                            if(isMatch(n)) hits++;
                            const matchClass = isMatch(n) ? 'match' : '';
                            return `<div class="mini-ball ${matchClass}">${String(n).padStart(2, '0')}</div>`;
                        }).join('');
                        
                        const hitLabel = hits > 0 ? (
                            window.config.gameType === 'megasena' ? (
                                hits === 4 ? `<span class="win-badge badge-quadra">QUADRA</span>` :
                                hits === 5 ? `<span class="win-badge badge-quina">QUINA</span>` :
                                hits === 6 ? `<span class="win-badge badge-sena">MEGA SENA</span>` :
                                `<span class="match-count" style="font-size:0.6em;color:#999;">${hits} ACERTO(S)</span>`
                            ) : (
                                // QUINA
                                hits === 2 ? `<span class="win-badge badge-quadra" style="background:#555;">DUQUE</span>` :
                                hits === 3 ? `<span class="win-badge badge-quadra">TERNO</span>` :
                                hits === 4 ? `<span class="win-badge badge-quina">QUADRA</span>` :
                                hits === 5 ? `<span class="win-badge badge-sena" style="background:linear-gradient(45deg, #8e44ad, #2980b9);">QUINA</span>` :
                                `<span class="match-count" style="font-size:0.6em;color:#999;">${hits} ACERTO(S)</span>`
                            )
                        ) : '';

                        gamesContent += `
                            <div class="h-game-row" style="display:flex; align-items:center;">
                                <span class="h-game-label">J${g.game}</span>
                                <div class="h-numbers" style="display:flex; gap:3px; flex-wrap:wrap;">${balls}</div>
                                ${hitLabel}
                            </div>
                        `;
                    });
                } else if (item.numbers) { // Backwards compatibility
                    const balls = item.numbers.map(n => {
                        if(isMatch(n)) hits++;
                        const matchClass = isMatch(n) ? 'match' : '';
                        return `<div class="mini-ball ${matchClass}">${String(n).padStart(2, '0')}</div>`;
                    }).join('');
                    
                    const hitLabel = hits > 0 ? (
                        window.config.gameType === 'megasena' ? (
                            hits === 4 ? `<span class="win-badge badge-quadra">QUADRA</span>` :
                            hits === 5 ? `<span class="win-badge badge-quina">QUINA</span>` :
                            hits === 6 ? `<span class="win-badge badge-sena">MEGA SENA</span>` :
                            `<span class="match-count" style="font-size:0.6em;color:#999;">${hits} ACERTO(S)</span>`
                        ) : (
                            // QUINA
                            hits === 2 ? `<span class="win-badge badge-quadra" style="background:#555;">DUQUE</span>` :
                            hits === 3 ? `<span class="win-badge badge-quadra">TERNO</span>` :
                            hits === 4 ? `<span class="win-badge badge-quina">QUADRA</span>` :
                            hits === 5 ? `<span class="win-badge badge-sena" style="background:linear-gradient(45deg, #8e44ad, #2980b9);">QUINA</span>` :
                            `<span class="match-count" style="font-size:0.6em;color:#999;">${hits} ACERTO(S)</span>`
                        )
                    ) : '';

                    gamesContent = `
                        <div class="h-game-row" style="display:flex; align-items:center;">
                            <span class="h-game-label">J1</span>
                            <div class="h-numbers" style="display:flex; gap:3px; flex-wrap:wrap;">${balls}</div>
                            ${hitLabel}
                        </div>
                     `;
                }

                li.innerHTML = `
                    <div class="h-info" style="align-items:center;">
                        <div style="display:flex; flex-direction:column;">
                             <span class="h-id">SIMULA√á√ÉO #${item.id}</span>
                             <span style="font-size:0.9em;">${new Date(item.date).toLocaleString('pt-BR')}</span>
                        </div>
                        <button class="btn-copy-history" onclick="copyHistoryItem(${item.id}, this)">Copiar</button>
                    </div>
                    <div class="h-games-list">
                        ${gamesContent}
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function clearHistory() {
            localStorage.removeItem('mega_history');
            window.location.reload(); 
        }

        // --- NEW FEATURES For Results ---

        async function fetchContest(concurso) {
            const label = document.getElementById('contestLabel');
            label.textContent = "Buscando...";
            
            // Helper to try multiple URLs
            const tryFetch = async (url) => {
                try {
                    const r = await fetch(url);
                    if(r.ok) return await r.json();
                } catch(e) { console.log("Falha na url: " + url); }
                return null;
            };

            // HELPER: Normalization Strategy
            const normalizeData = (d) => {
                 if(!d.listaDezenas && d.dezenas) d.listaDezenas = d.dezenas;
                 if(!d.numero && d.concurso) d.numero = d.concurso;
                 if(d.acumulado !== undefined && d.acumulou === undefined) d.acumulou = d.acumulado;
                 if(!d.premiacoes && d.listaRateioPremio) d.premiacoes = d.listaRateioPremio;
                 if(!d.localGanhadores && d.listaMunicipioUFGanhadores) d.localGanhadores = d.listaMunicipioUFGanhadores;
                 
                 // Values
                 if(!d.valorEstimadoProximo && d.valorEstimadoProximoConcurso) d.valorEstimadoProximo = d.valorEstimadoProximoConcurso;
                 if(!d.valorAcumuladoProximo && d.valorAcumuladoProximoConcurso) d.valorAcumuladoProximo = d.valorAcumuladoProximoConcurso;
                 if(!d.valorAcumuladoEspecial && d.valorAcumuladoConcurso_0_5) d.valorAcumuladoEspecial = d.valorAcumuladoConcurso_0_5;
                 
                 return d;
            };

            // CACHE STRATEGY: Check LocalStorage first to avoid Rate Limiting
            const cacheKey = `${window.config.gameType}_result_${concurso}`;
            const cached = localStorage.getItem(cacheKey);
            if(cached) {
                try {
                    let parsed = JSON.parse(cached);
                    parsed = normalizeData(parsed); // Re-normalize stale cache

                    // If it's the 'latest' cache, might be outdated, but specific numbers are safe
                    if(concurso !== 'latest') {
                        console.log("Usando cache local para " + concurso);
                        window.currentContestData = parsed;
                        
                        // Track latest
                         if (!window.latestKnownContest || parsed.numero > window.latestKnownContest) {
                            window.latestKnownContest = parsed.numero;
                        }

                        renderContestResults(parsed);
                        updateHistoryUI(parsed.listaDezenas.map(n => parseInt(n)));
                        return; // Done!
                    }
                } catch(e) {}
            }

            try {
                let data = null;
                const isLatest = concurso === 'latest';
                
                // 1. Try Guidi API (Reliable)
                // Format: https://api.guidi.dev/loteria/megasena/ultimo (or number)
                const guidiUrl = `https://api.guidi.dev/loteria/${window.config.gameType}/${isLatest ? 'ultimo' : concurso}`;
                let rawGuidi = await tryFetch(guidiUrl);
                
                if(rawGuidi && (rawGuidi.numero || rawGuidi.concurso)) {
                    // Normalize Guidi Data
                    data = {
                        numero: rawGuidi.numero || rawGuidi.concurso,
                        dataSorteio: rawGuidi.data || rawGuidi.dataSorteio,
                        listaDezenas: rawGuidi.listaDezenas || rawGuidi.dezenas,
                        // Detailed Info (Guidi structure varies, defensive coding)
                        acumulou: rawGuidi.acumulado,
                        premiacoes: rawGuidi.listaRateioPremio || [],
                        localGanhadores: rawGuidi.listaMunicipioUFGanhadores || [],
                        valorAcumuladoProximo: rawGuidi.valorAcumuladoProximoConcurso || 0,
                        valorEstimadoProximo: rawGuidi.valorEstimadoProximoConcurso || 0
                    };
                }

                // 2. If failed, try Heroku API
                if(!data) {
                    // Heroku API endpoint is strictly /megasena or /quina
                    const herokuGameSegment = window.config.gameType;
                    const herokuUrl = `https://loteriascaixa-api.herokuapp.com/api/${herokuGameSegment}/${isLatest ? 'latest' : concurso}`;
                    let rawHeroku = await tryFetch(herokuUrl);
                    if(rawHeroku) data = rawHeroku; 
                }

                // 3. Fallback to Local Proxy (Standard and Full URL)
                if(!data) {
                    // Relative path
                    let rawProxy = await tryFetch(`/api/${window.config.gameType}-proxy/${concurso}`);
                    if(rawProxy) data = rawProxy;
                    
                    if(!data) {
                        rawProxy = await tryFetch(`http://localhost:3000/api/${window.config.gameType}-proxy/${concurso}`);
                        if(rawProxy) data = rawProxy;
                    }
                }

                if(!data) throw new Error("Sem conex√£o com APIs");

                // Normalizing Data Fields
                if(!data.listaDezenas && data.dezenas) data.listaDezenas = data.dezenas;
                if(!data.numero && data.concurso) data.numero = data.concurso;
                
                // Detailed Fields Normalization (Coverage for Heroku/Proxy)
                if(data.acumulado !== undefined && data.acumulou === undefined) data.acumulou = data.acumulado;
                if(!data.premiacoes && data.listaRateioPremio) data.premiacoes = data.listaRateioPremio;
                if(!data.localGanhadores && data.listaMunicipioUFGanhadores) data.localGanhadores = data.listaMunicipioUFGanhadores;
                
                // Values
                if(!data.valorEstimadoProximo && data.valorEstimadoProximoConcurso) data.valorEstimadoProximo = data.valorEstimadoProximoConcurso;
                if(!data.valorAcumuladoProximo && data.valorAcumuladoProximoConcurso) data.valorAcumuladoProximo = data.valorAcumuladoProximoConcurso;
                // Capture special accumulation (Zero/Five contests)
                if(!data.valorAcumuladoEspecial && data.valorAcumuladoConcurso_0_5) data.valorAcumuladoEspecial = data.valorAcumuladoConcurso_0_5;

                // Validate
                if(!data.numero || !data.listaDezenas) {
                    console.error("Dados inv√°lidos recebidos:", data);
                    throw new Error("Dados inv√°lidos");
                }
                
                // SAVE TO CACHE (Only specific contests, not 'latest' key)
                localStorage.setItem(`${window.config.gameType}_result_${data.numero}`, JSON.stringify(data));
                
                // Store globally
                window.currentContestData = data;
                
                // Track latest for button locking
                if (isLatest || !window.latestKnownContest || data.numero > window.latestKnownContest) {
                    window.latestKnownContest = data.numero;
                }
                
                // Render
                renderContestResults(data, isLatest); // Pass isLatest flag
                
                // Check matches
                const winningNums = data.listaDezenas.map(n => parseInt(n));
                updateHistoryUI(winningNums);
                
            } catch(e) {
                console.error(e);
                label.innerHTML = `<span style="color:#d63031; font-size:0.8em;">Falha na Rede</span>`;
                // Show a mini retry button
                setTimeout(() => { 
                     // Check if still showing failure before adding button
                     if(label.innerText.includes("Falha")) {
                         label.innerHTML = `<button onclick="fetchContest('${concurso}')" style="font-size:0.7em; cursor:pointer;">Tentar Novamente</button>`;
                     }
                }, 2000);
            }
        }
        
        function renderContestResults(data, isLatest = false) {
             const label = document.getElementById('contestLabel');
             const date = document.getElementById('contestDate');
             const container = document.getElementById('contestResults');
             const btnNext = document.getElementById('btnNextContest');
             
             // Elements for detailed info
             const badge = document.getElementById('resStatusBadge');
             const prizeEl = document.getElementById('resPrize');
             const locEl = document.getElementById('resLocation');

             label.textContent = `CONCURSO ${data.numero}`;
             // Fix Date Display: Check 'data', 'dataSorteio', 'dt_apuracao'
             date.textContent = `DATA: ${data.data || data.dataSorteio || data.data_apuracao || data.dt_apuracao || '--/--/----'}`;
             
             // --- DETAILED INFO RENDER ---
             // 1. Accumulation Status
             const isAccumulated = data.acumulou === true;
             badge.style.display = 'inline-block';
             
             if(isAccumulated) {
                 badge.textContent = "ACUMULOU!";
                 badge.className = "status-badge status-accumulated";
             } else {
                 badge.textContent = "PREMIO SAIU!";
                 badge.className = "status-badge status-won";
             }
             
             // 2. Prize Value
             // Logic: Prioritize best value based on context (History vs Latest)
             let prizeValue = 0;
             const formatMoney = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
             
             if(isAccumulated) {
                 // Unified Logic: User prefers "Estimativa" for all.
                 // We try Estimated first. If 0 (common in history), we fallback to Actual Accumulated.
                 prizeValue = data.valorEstimadoProximo || data.valorAcumuladoProximo || data.valorAcumuladoEspecial || 0;
                 
                 // Label as "Estimativa" as requested, unless we are strictly showing the exact accumulated
                 // But let's stick to a generic "Pr√≥ximo Pr√™mio" or keep "Estimativa" to match user request.
                 prizeEl.textContent = "Estimativa: " + formatMoney(prizeValue);
                 locEl.textContent = "";
             } else {
                 // Find winner prize
                 // Normalize 'premiacoes' which might be different in APIs
                 let sena = null;
                 if(data.premiacoes && Array.isArray(data.premiacoes)) {
                     // Get main prize tier based on game
                     const mainTier = window.config.gameType === 'megasena' ? 'Sena' : 'Quina';
                     sena = data.premiacoes.find(p => p.faixa === mainTier || p.descricao?.toLowerCase().includes(mainTier.toLowerCase()) || p.faixa === 1);
                 }
                 
                 if(sena) {
                     prizeValue = sena.valorPremio;
                     prizeEl.textContent = formatMoney(prizeValue);
                     
                     // 3. Winners Location
                     if(data.localGanhadores && data.localGanhadores.length > 0) {
                        const locs = data.localGanhadores.map(l => `${l.municipio}/${l.uf}`).join(', ');
                        locEl.textContent = "Ganhadores: " + locs;
                     } else {
                        locEl.textContent = "Ganhador(es) n√£o divulgado(s)";
                     }
                 } else {
                     prizeEl.textContent = "Verificar Site Oficial";
                     locEl.textContent = "";
                 }
             }

             // Lock Next Button if latest
             if (window.latestKnownContest && data.numero >= window.latestKnownContest) {
                 btnNext.disabled = true;
                 btnNext.style.opacity = "0.3";
                 btnNext.style.cursor = "default";
             } else {
                 btnNext.disabled = false;
                 btnNext.style.opacity = "1";
                 btnNext.style.cursor = "pointer";
             }
             
             container.innerHTML = '';
             data.listaDezenas.forEach(d => {
                 const ball = document.createElement('div');
                 ball.className = 'result-ball';
                 ball.textContent = d;
                 container.appendChild(ball);
             });
             
             // Update our local state tracker
             // Accessing the initMegaPage scope variable is hard if not exposed.
             // We modified initMegaPage to define 'currentContestData' in scope, 
             // but 'renderContestResults' is outside?
             // Ah, I placed renderContestResults outside of initMegaPage in this chunk? 
             // Wait, the ReplacementChunk replaces the end of initMegaPage functions.
             // Ideally these new functions should be INSIDE initMegaPage or accessible.
             // The chunk replaces `function addToHistory...` which is inside `initMegaPage`.
             // So these functions are inside `initMegaPage`. Good.
             
             // We need to update the `currentContestData` let variable defined at start of initMegaPage
             // Since we are inside the closure, we can access it.
             // BUT, verify where I defined `currentContestData`. I defined it in a previous chunk.
             
             // However, `renderContestResults` needs to set `currentContestData = data`.
             // I'll add that line here.
             
             // NOTE: JavaScript closure variable access depends on being in the same scope.
             // I am adding these functions at the end of initMegaPage (replacing helper functions).
             // So yes, I can read/write `currentContestData`.
             
             // Since I can't easily reference the variable from the prev chunk unless I rewrite the whole function,
             // I will assume `currentContestData` is available.
             // Actually, to be safe, I'll pass it or use a safer pattern. 
             // But let's trust the closure.
             
             // Wait, I need to make sure I assign it.
             // I can't see the assignment in this function body unless I write it.
             // I'll add `currentContestData = data;`
        }

        // Just a small hack to ensure `currentContestData` is updated inside `renderContestResults` 
        // without redeclaring it or causing a reference error if I messed up the chunks.
        // Actually, in the chunk that defines `fetchContest`, I didn't assign `currentContestData`.
        // I'll fix fetchContest in this chunk to assign it.
        
        // Revised fetchContest below (in this replacement content):
        // It's already there in the big replacement block? 
        // No, I need to make sure `currentContestData` is assigned.
        
        // I will declare a minimal renderContestResults inside the replacement 
        // that assigns the closure variable.
        
        /* 
           Wait, there is a risk. `currentContestData` was defined in chunk 3 (start of initMegaPage).
           The functions `fetchContest` etc are being added in chunk 5 (end of initMegaPage).
           So they share scope. Correct.
        */
    </script>
</body>

</html>